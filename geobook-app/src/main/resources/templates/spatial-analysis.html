<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Analysis - GeoBook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        #analysisMap {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .navbar {
        backdrop-filter: blur(10px);
        background-color: #007bff; 
        }
        .analysis-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .entity-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .analysis-results {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">GeoBook</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav">
                     <a class="nav-link" href="/books">Books</a>
                    <a class="nav-link" href="/locations">Locations</a>
                    <a class="nav-link active" href="/multimedia">Multimedia</a>
                
                    <a class="nav-link active" href="/map">Map</a>
                    <a class="nav-link" href="/logout">Logout</a>
                </div>
            </div>
        </div>
    </nav>

        <div class="container-fluid mt-4">
            <div class="row">
                <!-- Spatial Analysis Controls -->
                <div class="col-md-4">
                    <div class="analysis-controls">
                        <h4>Spatial Operations</h4>
                        
                        <!-- Intersection Analysis -->
                        <div class="mb-3">
                            <h6>Find Intersections</h6>
                            <form th:action="@{/map/spatial/intersections}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <div class="row">
                                    <div class="col-6">
                                        <select name="entityType1" class="form-select form-select-sm">
                                            <option value="POLYGON">Polygons</option>
                                            <option value="LINESTRING">Lines</option>
                                            <option value="CIRCLE">Circles</option>
                                            <option value="RECTANGLE">Rectangles</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select name="entityType2" class="form-select form-select-sm">
                                            <option value="POLYGON">Polygons</option>
                                            <option value="LINESTRING">Lines</option>
                                            <option value="CIRCLE">Circles</option>
                                            <option value="RECTANGLE">Rectangles</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm mt-2">Find Intersections</button>
                            </form>
                        </div>

                    </div>

                    <div class="analysis-controls">
                        <h4>Analytic Functions</h4>
                        
                        <!-- Density Analysis -->
                        <div class="mb-3">
                            <h6>Density Analysis</h6>
                            <form th:action="@{/map/analysis/density}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <select name="regionType" class="form-select form-select-sm mb-2">
                                    <option value="POLYGON">Polygons</option>
                                    <option value="CIRCLE">Circles</option>
                                    <option value="RECTANGLE">Rectangles</option>
                                </select>
                                <button type="submit" class="btn btn-info btn-sm">Calculate Density</button>
                            </form>
                        </div>                                         
                    </div>

                    <!-- Entity Statistics -->
                    <div class="analysis-controls" th:if="${entityCounts}">
                        <h4>Entity Statistics</h4>
                        <div th:each="entry : ${entityCounts}">
                            <span class="badge bg-primary me-2" th:text="${entry.key}"></span>
                            <span th:text="${entry.value}"></span>
                        </div>
                    </div>
                </div>

                <!-- Map and Results -->
                <div class="col-md-8">
                    <!-- Analysis Map -->
                    <div id="analysisMap"></div>

                    <!-- Success/Error Messages -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                    <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>

                    <!-- Analysis Results -->
                    <div class="analysis-results">
                        <!-- Intersection Results -->
                        <div th:if="${operationType == 'INTERSECTION'}" class="card">
                            <div class="card-header">
                                <h5>Intersection Analysis Results</h5>
                                <small th:text="'Between ' + ${entityType1} + ' and ' + ${entityType2}"></small>
                            </div>
                            <div class="card-body">
                                <div th:if="${intersections != null and !intersections.empty}">
                                    <div th:each="intersection : ${intersections}" class="entity-card">
                                        <strong th:text="${intersection.entity1_name} + ' ∩ ' + ${intersection.entity2_name}"></strong>
                                        <br><small th:text="${intersection.entity1_type} + ' intersects with ' + ${intersection.entity2_type}"></small>
                                    </div>
                                </div>
                                <div th:if="${intersections == null or intersections.empty}">
                                    <p class="text-muted">No intersections found.</p>
                                </div>
                            </div>
                        </div>

                                               
                        <!-- Density Analysis Results -->
                        <div th:if="${analysisType == 'DENSITY'}" class="card">
                            <div class="card-header">
                                <h5>Density Analysis Results</h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${densityResults != null and !densityResults.empty}">
                                    <div th:each="result : ${densityResults}" class="entity-card">
                                        <strong th:text="${result.region_name}"></strong>
                                        <div class="row">
                                            <div class="col-6">Point Count: <span th:text="${result.point_count}"></span></div>
                                            <div class="col-6">Density: <span th:text="${result.density_per_unit_area}"></span></div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${densityResults == null or densityResults.empty}">
                                    <p class="text-muted">No density data available.</p>
                                </div>
                            </div>
                        </div>

                       
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize the analysis map
        var map = L.map('analysisMap').setView([40.7128, -74.0060], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add spatial entities to map
        var spatialEntities = /*[[${spatialEntities}]]*/ [];
        var locations = /*[[${locations}]]*/ [];

        // Display locations as blue markers
        locations.forEach(function(location) {
            if (location.latitude && location.longitude) {
                L.marker([location.latitude, location.longitude])
                    .bindPopup('<b>' + location.placeName + '</b>')
                    .addTo(map);
            }
        });

        // Display spatial entities (simplified - in real implementation, you'd parse the geometry)
        spatialEntities.forEach(function(entity) {
            // This is a simplified display - you'd need to parse the actual SDO_GEOMETRY
            // For now, just show entity info in console
            console.log('Entity:', entity.name, entity.entityType);
        });

        // Add buffer geometry if available
        var bufferGeometry = /*[[${bufferGeometry}]]*/ null;
        if (bufferGeometry) {
            console.log('Buffer geometry available:', bufferGeometry);
        }
    </script>
</body>
</html>
